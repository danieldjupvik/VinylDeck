# Milestone v1.1: Improve API Types

**Status:** SHIPPED 2026-02-06
**Phases:** 4-8
**Total Plans:** 9

## Overview

Type-safe, maintainable Discogs API integration with facade architecture. Replaced 739 lines of hand-written types with discojs imports, added server-side rate limiting, and created a facade layer hiding dual-library complexity.

## Phases

### Phase 4: Type System Foundation

**Goal**: Replace custom types with discojs imports and module augmentation
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:

- [x] 04-01: Create discojs type system and migrate all imports

**Details:**

- Installed discojs@2.3.1 for Discogs API types
- Created barrel export at src/types/discogs/ using ReturnType extraction
- Extracted OAuth types from @lionralfs via ReturnType inference
- Extended User type with missing banner_url field
- Migrated all imports with zero breaking changes

### Phase 5: Rate Limiting

**Goal**: Reactive 429 error handling and rate state exposure (proactive throttling handled by discojs built-in Bottleneck)
**Depends on**: Phase 3
**Plans**: 1 plan

Plans:

- [x] 05-01: Create retry infrastructure and rate state tracking

**Details:**

- withRateLimitRetry wrapper with exponential backoff + jitter
- RateLimitError class with retryAfterMs property
- Rate state singleton (getRateLimitState/updateRateLimitState)
- Configured for 60 req/min (auth) and 25 req/min (unauth)

### Phase 6: Facade Layer

**Goal**: Single entry point hiding dual-library complexity
**Depends on**: Phase 4, Phase 5
**Plans**: 2 plans

Plans:

- [x] 06-01: Create facade with OAuth and data client wrappers
- [x] 06-02: Fix DataClient to return extended types (gap closure)

**Details:**

- createDiscogsClient() factory with { oauth, data } namespaces
- OAuth operations via @lionralfs (getRequestToken, getAccessToken)
- Data operations via discojs with retry (getIdentity, getCollectionReleases, getUserProfile)
- Unified error types (DiscogsApiError, DiscogsAuthError, DiscogsRateLimitError)
- Gap closure: DataClient interface updated to return extended types from barrel

### Phase 7: tRPC Integration

**Goal**: tRPC routers consume facade with type-safe responses
**Depends on**: Phase 6
**Plans**: 2 plans

Plans:

- [x] 07-01: Error mapper, facade getCollectionMetadata, OAuth router migration
- [x] 07-02: Discogs router migration, hook updates, old file cleanup

**Details:**

- mapFacadeErrorToTRPC bridges facade errors to tRPC error codes
- All 6 tRPC procedures migrated to facade
- Flat response shapes (no wrapper objects)
- Zero `as unknown as` type casts remaining
- Deleted deprecated error-utils.ts and discogs-client.ts

### Phase 8: Cleanup

**Goal**: Remove deprecated code and complete migration
**Depends on**: Phase 7
**Plans**: 3 plans

Plans:

- [x] 08-01: Dead code removal, orphan scan, unused dependency cleanup
- [x] 08-02: Documentation sync (CLAUDE.md, GEMINI.md, AGENTS.md)
- [x] 08-03: Fix vercel build TS2554 in facade error classes (gap closure)

**Details:**

- Deleted 964 lines of dead code (rate-limiter.ts, discogs-legacy.ts, augment.ts)
- Moved RATE_LIMIT constants to rate-state.ts (co-location)
- Removed unused motion dependency
- Rewrote agent docs to reflect facade architecture
- Fixed Vercel TS compat: manual Error.cause assignment + declare keyword

---

## Milestone Summary

**Key Decisions:**

- Hybrid @lionralfs + discojs: Best of both â€” OAuth flow + proper types
- Import types via ReturnType extraction: Auto-sync on discojs updates
- Facade pattern: Hide library complexity, easy to swap/extend
- Grouped namespaces: client.oauth._ and client.data._ for clear routing
- Reactive rate limiting: withRateLimitRetry for 429 recovery (Bottleneck for proactive)
- Flat tRPC responses: No wrapper objects, facade types flow through naturally
- Manual Error.cause for Vercel TS compat: super(message) + this.cause assignment

**Issues Resolved:**

- 739 lines of unverified hand-written types replaced with library imports
- `as unknown as` casts eliminated from tRPC routers
- No proactive rate limiting (now handled by discojs Bottleneck)
- Vercel build TS2554 in facade error classes

**Issues Deferred:**

- banner_url missing from discojs upstream (extended locally via type intersection)
- **APP_VERSION** TypeScript error in vercel build (pre-existing on main, not v1.1 related)

**Technical Debt Incurred:**

None. All migration artifacts cleaned up in Phase 8.

---

_For current project status, see .planning/MILESTONES.md_
