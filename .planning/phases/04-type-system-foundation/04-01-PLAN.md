---
phase: 04-type-system-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bun.lockb
  - src/types/discogs/oauth.ts
  - src/types/discogs/augment.ts
  - src/types/discogs/index.ts
autonomous: true

must_haves:
  truths:
    - 'discojs is installed as a dependency'
    - 'OAuth types are extracted from @lionralfs via ReturnType inference'
    - 'Missing User fields (avatar_url, banner_url) are augmented onto discojs types'
    - 'All Discogs types are accessible from single import path'
  artifacts:
    - path: 'src/types/discogs/oauth.ts'
      provides: 'OAuth type extraction from @lionralfs'
      exports:
        [
          'RequestTokenResult',
          'AccessTokenResult',
          'OAuthTokens',
          'OAuthRequestTokens'
        ]
    - path: 'src/types/discogs/augment.ts'
      provides: 'Module augmentation for missing discojs fields'
      contains: "declare module 'discojs'"
    - path: 'src/types/discogs/index.ts'
      provides: 'Barrel export for all Discogs types'
      exports:
        [
          'User',
          'Identity',
          'CollectionRelease',
          'BasicInformation',
          'Pagination'
        ]
  key_links:
    - from: 'src/types/discogs/index.ts'
      to: 'src/types/discogs/augment.ts'
      via: 'side-effect import'
      pattern: "import './augment"
    - from: 'src/types/discogs/index.ts'
      to: 'discojs'
      via: 'type re-export'
      pattern: "from 'discojs"
---

<objective>
Create discojs-based type system with module augmentation and OAuth type extraction.

Purpose: Establish type foundation that auto-syncs with discojs updates and provides type-safe OAuth types extracted from @lionralfs.
Output: New `src/types/discogs/` directory with barrel export, augmentation, and OAuth types.
</objective>

<execution_context>
@/Users/danieldjupvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danieldjupvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-type-system-foundation/04-CONTEXT.md
@.planning/phases/04-type-system-foundation/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install discojs and create type infrastructure</name>
  <files>
    package.json
    bun.lockb
    src/types/discogs/oauth.ts
    src/types/discogs/augment.ts
    src/types/discogs/index.ts
  </files>
  <action>
1. Install discojs:
   ```bash
   bun add discojs
   ```

2. Create `src/types/discogs/oauth.ts`:
   - Import DiscogsOAuth from @lionralfs/discogs-client
   - Extract RequestTokenResult and AccessTokenResult using ReturnType inference:
     ```typescript
     type OAuthInstance = InstanceType<typeof DiscogsOAuth>
     export type RequestTokenResult = Awaited<
       ReturnType<OAuthInstance['getRequestToken']>
     >
     export type AccessTokenResult = Awaited<
       ReturnType<OAuthInstance['getAccessToken']>
     >
     ```
   - Include OAuthTokens interface (app-level token storage, same as current):
     ```typescript
     export interface OAuthTokens {
       accessToken: string
       accessTokenSecret: string
     }
     ```
   - Include OAuthRequestTokens interface (temporary session tokens):
     ```typescript
     export interface OAuthRequestTokens {
       requestToken: string
       requestTokenSecret: string
     }
     ```
   - Add JSDoc comments documenting source of each type

3. Create `src/types/discogs/augment.ts`:
   - Import 'discojs' to trigger module resolution
   - Use `declare module 'discojs'` to augment the User interface
   - Add avatar_url and banner_url as optional strings:
     ```typescript
     declare module 'discojs' {
       interface User {
         /** @endpoint GET /users/{username} @optional Users without avatars */
         avatar_url?: string
         /** @endpoint GET /users/{username} @optional Users without banners */
         banner_url?: string
       }
     }
     ```
   - Include JSDoc explaining why each field is augmented

4. Create `src/types/discogs/index.ts`:
   - Import augmentation first (side-effect): `import './augment.js'`
   - Re-export discojs types with explicit named exports:
     ```typescript
     export type { User, Identity, BasicInformation, Pagination } from 'discojs'
     ```
   - Re-export CollectionRelease (check discojs exports for exact name)
   - Re-export application-specific types that will stay in this codebase:
     - CollectionSortKey, CollectionSortOrder, DiscogsCollectionSortKey (client-side sort enums)
     - DiscogsFormat (if not in discojs)
   - Re-export OAuth types: `export * from './oauth.js'`

NOTE: Check discojs type exports carefully. The library may use different names than current codebase (e.g., `CollectionItem` vs `DiscogsCollectionRelease`). Map appropriately with type aliases if needed:

```typescript
export type { CollectionItem as DiscogsCollectionRelease } from 'discojs'
```

  </action>
  <verify>
    - `bun install` completes without errors
    - `ls src/types/discogs/` shows oauth.ts, augment.ts, index.ts
    - TypeScript compiles the new files: `bunx tsc --noEmit src/types/discogs/index.ts`
  </verify>
  <done>
    - discojs appears in package.json dependencies
    - Three new files exist in src/types/discogs/
    - All types are accessible via import from the barrel file
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate all type imports to new barrel</name>
  <files>
    src/providers/auth-context.ts
    src/lib/oauth-session.ts
    src/hooks/use-collection.ts
    src/hooks/use-collection-sync.ts
    src/components/collection/vinyl-grid.tsx
    src/components/collection/vinyl-card.tsx
    src/components/collection/vinyl-table.tsx
    src/components/collection/collection-toolbar.tsx
    src/server/trpc/routers/discogs.ts
  </files>
  <action>
1. Update client-side imports (use @/ alias):
   - `src/providers/auth-context.ts`: Change `from '@/types/discogs'` to `from '@/types/discogs'` (path stays same, barrel handles it)
   - `src/lib/oauth-session.ts`: Same pattern
   - `src/hooks/use-collection.ts`: Same pattern
   - `src/hooks/use-collection-sync.ts`: Same pattern
   - `src/components/collection/*.tsx`: Same pattern

2. Update server-side imports (use relative paths with .js extension per Vercel requirements):
   - `src/server/trpc/routers/discogs.ts`: Change `from '../../../types/discogs.js'` to `from '../../../types/discogs/index.js'`

3. Type name mapping (if discojs uses different names):
   - If discojs exports `CollectionItem`, update barrel to alias: `export type { CollectionItem as DiscogsCollectionRelease }`
   - If discojs exports `Release` for collection items, same approach
   - Consumer code should NOT change type names — barrel handles mapping

4. Handle types that stay local (not from discojs):
   - CollectionSortKey, CollectionSortOrder, DiscogsCollectionSortKey — these are app-specific sort enums
   - Move these definitions to the barrel file or keep in a local-types section of index.ts
   - DiscogsFormat — check if discojs has Format type; if not, define locally

5. Run full TypeScript check:

   ```bash
   bunx tsc --noEmit
   ```

   Fix any type errors that surface.

6. Run Vercel build to catch server-side issues:
   ```bash
   vercel build
   ```
   (or `bunx tsc -b` if vercel CLI not set up)
   </action>
   <verify> - `bunx tsc --noEmit` passes with no errors - `bun run build` succeeds - `bun run lint` passes
   </verify>
   <done> - All imports updated to use new barrel path - No TypeScript errors in codebase - Build succeeds locally
   </done>
   </task>

</tasks>

<verification>
Run the following to verify phase completion:

```bash
# TypeScript compilation
bunx tsc --noEmit

# Full build (includes Vite + type checking)
bun run build

# Lint check
bun run lint
```

All commands should pass without errors.
</verification>

<success_criteria>

- discojs installed as dependency
- src/types/discogs/ directory exists with oauth.ts, augment.ts, index.ts
- All codebase imports use new type paths
- TypeScript compiles without errors
- Build succeeds
- Old src/types/discogs.ts still exists (deletion deferred to Phase 8)
  </success_criteria>

<output>
After completion, create `.planning/phases/04-type-system-foundation/04-01-SUMMARY.md`
</output>
