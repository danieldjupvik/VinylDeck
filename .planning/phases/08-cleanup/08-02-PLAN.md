---
phase: 08-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - GEMINI.md
  - AGENTS.md
autonomous: true

must_haves:
  truths:
    - 'Project Structure section lists src/server/discogs/, src/server/trpc/, and src/types/discogs/'
    - 'API Layer section describes facade pattern (dual-library: @lionralfs for OAuth, discojs for data)'
    - 'Rate Limiting description references server-side withRateLimitRetry + Bottleneck, not src/api/rate-limiter.ts'
    - 'No reference to old rate-limiter.ts path in any doc file'
    - 'tRPC procedure list reflects flat response shapes'
    - 'GEMINI.md and AGENTS.md are identical to CLAUDE.md'
  artifacts:
    - path: 'CLAUDE.md'
      provides: 'Accurate project documentation reflecting facade architecture'
      contains: 'facade'
    - path: 'GEMINI.md'
      provides: 'Mirror of CLAUDE.md'
    - path: 'AGENTS.md'
      provides: 'Mirror of CLAUDE.md'
  key_links:
    - from: 'CLAUDE.md Project Structure'
      to: 'actual directory layout'
      via: 'accurate path descriptions'
      pattern: 'src/server/discogs/'
    - from: 'CLAUDE.md API Layer'
      to: 'facade architecture'
      via: 'documentation'
      pattern: 'withRateLimitRetry'
---

<objective>
Update CLAUDE.md (and its mirrors GEMINI.md, AGENTS.md) to accurately describe the post-migration facade architecture, replacing outdated references to deleted files and old patterns.

Purpose: Ensure documentation reflects the actual codebase so new contributors (human or AI) understand the current architecture.
Output: Three identical doc files with accurate Project Structure, API Layer, and Rate Limiting sections.
</objective>

<execution_context>
@/Users/danieldjupvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danieldjupvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-cleanup/08-RESEARCH.md
@.planning/phases/08-cleanup/08-CONTEXT.md

@CLAUDE.md
@src/server/discogs/index.ts
@src/server/trpc/routers/discogs.ts
@src/server/trpc/routers/oauth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite API-related sections in CLAUDE.md</name>
  <files>CLAUDE.md</files>
  <action>
    Read the full CLAUDE.md file. Make targeted edits to these specific sections (leave all other sections unchanged):

    **1. Project Structure (around line 106-121)**
    Replace the current `src/server/` line and `src/types/` line with expanded entries. The updated section should include:
    - `src/server/discogs/` - Discogs API facade (dual-library: @lionralfs for OAuth, discojs for data)
    - `src/server/trpc/` - tRPC router definitions and error mapper
    - `src/types/discogs/` - Discogs type definitions (extracted from discojs + @lionralfs)
    Remove the old `src/server/` line that says "tRPC routers, Discogs client factory" as it's inaccurate.

    **2. API Layer / tRPC (around line 297-313)**
    Rewrite this section to describe the current facade architecture:
    - The call chain is: Client (React) -> tRPC Client -> Vercel Serverless Function -> Facade -> Discogs API
    - Facade (`src/server/discogs/`) wraps two libraries: @lionralfs/discogs-client for OAuth 1.0a signing, discojs for typed data operations
    - tRPC routers import only from the facade, never from libraries directly
    - Keep the available procedures list (it's still accurate)
    - Replace the Rate Limiting line. The new description should explain:
      - Server-side rate limiting via `withRateLimitRetry` (exponential backoff + jitter on 429 responses)
      - Proactive throttling via discojs built-in Bottleneck
      - Rate state tracked in `src/server/discogs/rate-state.ts`
      - No client-side rate limiting (the old passive rate limiter has been removed)

    **What NOT to change:**
    - Do not add a separate "Facade" section -- mention it in the API Layer section per user decision
    - Do not change any other sections (Auth, PWA, State Management, Collection, Theme, Security, etc.)
    - Do not change the Tech Stack section
    - Exact wording is at your discretion (per user decision on Claude's Discretion)

  </action>
  <verify>
    Grep CLAUDE.md for "rate-limiter" -- should return zero results.
    Grep CLAUDE.md for "src/server/discogs/" -- should find it in Project Structure.
    Grep CLAUDE.md for "facade" -- should find it in API Layer section.
    Grep CLAUDE.md for "withRateLimitRetry" -- should find it in Rate Limiting description.
  </verify>
  <done>
    CLAUDE.md Project Structure lists the three new directories. API Layer describes facade pattern. Rate Limiting describes server-side approach. No references to deleted files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mirror CLAUDE.md to GEMINI.md and AGENTS.md</name>
  <files>
    GEMINI.md
    AGENTS.md
  </files>
  <action>
    Copy the updated CLAUDE.md content to both GEMINI.md and AGENTS.md. These three files must be byte-identical.

    Read the updated CLAUDE.md, then write it to GEMINI.md and AGENTS.md.

    Verify all three files match with `diff`.

  </action>
  <verify>
    `diff CLAUDE.md GEMINI.md` -- no output (identical).
    `diff CLAUDE.md AGENTS.md` -- no output (identical).
  </verify>
  <done>
    GEMINI.md and AGENTS.md are exact copies of the updated CLAUDE.md. All three files describe the current facade architecture.
  </done>
</task>

</tasks>

<verification>
1. `grep -c "rate-limiter" CLAUDE.md` returns 0
2. `grep -c "src/server/discogs/" CLAUDE.md` returns at least 1
3. `grep -c "facade" CLAUDE.md` returns at least 1
4. `grep -c "withRateLimitRetry" CLAUDE.md` returns at least 1
5. `diff CLAUDE.md GEMINI.md` produces no output
6. `diff CLAUDE.md AGENTS.md` produces no output
</verification>

<success_criteria>

- Project Structure section accurately lists src/server/discogs/, src/server/trpc/, src/types/discogs/
- API Layer section describes facade architecture with dual-library approach
- Rate Limiting section describes server-side withRateLimitRetry + Bottleneck
- No references to deleted files (rate-limiter.ts, discogs-client.ts)
- All three doc files are identical
  </success_criteria>

<output>
After completion, create `.planning/phases/08-cleanup/08-02-SUMMARY.md`
</output>
