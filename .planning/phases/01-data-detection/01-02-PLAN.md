---
phase: 01-data-detection
plan: 02
type: execute
wave: 2
depends_on: ['01-01']
files_modified:
  - src/stores/preferences-store.ts
  - src/hooks/use-changelog.ts
autonomous: true

must_haves:
  truths:
    - 'lastSeenVersion field persists to localStorage'
    - 'useChangelog returns new versions when lastSeenVersion is older'
    - 'useChangelog returns empty result on first install (null lastSeenVersion)'
    - 'useChangelog returns empty result when up-to-date'
    - 'Version comparison handles 0.9 < 0.10 correctly'
  artifacts:
    - path: 'src/stores/preferences-store.ts'
      provides: 'lastSeenVersion field and setter'
      contains: 'lastSeenVersion'
    - path: 'src/hooks/use-changelog.ts'
      provides: 'Hook returning changelog entries for new versions'
      exports: ['useChangelog', 'ChangelogResult']
  key_links:
    - from: 'src/hooks/use-changelog.ts'
      to: 'src/stores/preferences-store.ts'
      via: 'Zustand selector'
      pattern: 'usePreferencesStore.*lastSeenVersion'
    - from: 'src/hooks/use-changelog.ts'
      to: 'src/data/changelog.ts'
      via: 'data import'
      pattern: "import.*changelog.*from '@/data/changelog'"
    - from: 'src/hooks/use-changelog.ts'
      to: 'compare-versions'
      via: 'library import'
      pattern: "import.*compare.*from 'compare-versions'"
---

<objective>
Extend preferences store with version tracking and create the useChangelog hook for version detection.

Purpose: Enable the app to track which version the user last saw and determine what's new. This is the detection logic that Phase 2's modal will consume.
Output: Preferences store with lastSeenVersion persistence, and a hook that returns changelog entries for versions newer than last seen.
</objective>

<execution_context>
@/Users/danieldjupvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danieldjupvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-detection/01-CONTEXT.md
@.planning/phases/01-data-detection/01-RESEARCH.md
@.planning/phases/01-data-detection/01-01-SUMMARY.md
@src/stores/preferences-store.ts
@src/hooks/use-online-status.ts
@src/types/changelog.ts
@src/data/changelog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend preferences-store with lastSeenVersion</name>
  <files>src/stores/preferences-store.ts</files>
  <action>
Extend the existing preferences store:

1. Add to PreferencesStore interface:
   - `lastSeenVersion: string | null` (null = first install, string = last version user saw)
   - `setLastSeenVersion: (version: string) => void`

2. Add to store initial state:
   - `lastSeenVersion: null`

3. Add setter action:
   - `setLastSeenVersion: (version) => set({ lastSeenVersion: version })`

4. Add Zustand persist migration:
   - Increment version to 1 in persist config
   - Add migrate function that handles version 0 (existing users without lastSeenVersion):
     ```typescript
     version: 1,
     migrate: (persisted, version) => {
       if (version === 0) {
         return { ...(persisted as object), lastSeenVersion: null }
       }
       return persisted as PreferencesStore
     }
     ```

Important: The null value for first-install is intentional. It allows distinguishing "never seen any version" from "saw version X". First-install users should NOT see the changelog modal (everything is new to them).

TSDoc not required for store fields (internal), but update the file-level comment if needed.
</action>
<verify>

1. `bun run build` succeeds
2. Clear localStorage, reload app, check localStorage for 'vinyldeck-prefs' - should contain lastSeenVersion: null
3. Manually set via devtools: `usePreferencesStore.getState().setLastSeenVersion('0.1.0')` - value persists after refresh
   </verify>
   <done>
   preferences-store.ts has lastSeenVersion field (defaulting to null).
   setLastSeenVersion action exists.
   Migration handles existing users (version 0 -> 1).
   Value persists to localStorage under 'vinyldeck-prefs' key.
   </done>
   </task>

<task type="auto">
  <name>Task 2: Create useChangelog hook with version detection</name>
  <files>src/hooks/use-changelog.ts</files>
  <action>
Create `src/hooks/use-changelog.ts`:

1. Define ChangelogResult discriminated union type:

   ```typescript
   export type ChangelogResult =
     | { hasEntries: true; versions: ChangelogVersion[] }
     | {
         hasEntries: false
         reason: 'first-install' | 'up-to-date' | 'no-user-entries'
       }
   ```

2. Implement useChangelog hook:
   - Import `compare` from 'compare-versions'
   - Import `changelog` from '@/data/changelog'
   - Import `usePreferencesStore` for lastSeenVersion
   - Use useMemo for computation

3. Hook logic:
   - If lastSeenVersion is null: return `{ hasEntries: false, reason: 'first-install' }`
   - Filter changelog entries where `compare(entry.version, lastSeenVersion, '>')` is true
   - If no versions pass filter: return `{ hasEntries: false, reason: 'up-to-date' }`
   - If versions exist but all have empty categories: return `{ hasEntries: false, reason: 'no-user-entries' }`
   - Otherwise: return `{ hasEntries: true, versions: filteredVersions }`

4. Version array should be newest first (inherits from changelog data order)

TSDoc required:

```typescript
/**
 * Returns changelog entries for versions newer than the user's last-seen version.
 *
 * @returns ChangelogResult - either versions to display or a reason why there are none
 */
```

Follow existing hook patterns (see use-online-status.ts for style).
</action>
<verify>

1. `bun run build` succeeds
2. `bun run lint` passes
3. Manual test in browser console:
   - Set lastSeenVersion to old version: should return hasEntries: true with versions
   - Set lastSeenVersion to current version: should return hasEntries: false, reason: 'up-to-date'
   - Clear lastSeenVersion (set to null): should return hasEntries: false, reason: 'first-install'
4. Version comparison test: Set lastSeenVersion to '0.9.0', add changelog entry for '0.10.0' - hook should return '0.10.0' as newer
   </verify>
   <done>
   src/hooks/use-changelog.ts exports useChangelog and ChangelogResult.
   Hook correctly filters versions newer than lastSeenVersion.
   Hook returns distinct reason codes for empty results.
   Semver comparison handles 0.9 < 0.10 correctly (via compare-versions).
   </done>
   </task>

</tasks>

<verification>
After both tasks:
1. `bun run build` completes without errors
2. `bun run lint` passes
3. preferences-store persists lastSeenVersion to localStorage
4. useChangelog hook returns correct results for all three scenarios:
   - First install (null) -> { hasEntries: false, reason: 'first-install' }
   - Up to date -> { hasEntries: false, reason: 'up-to-date' }
   - New versions available -> { hasEntries: true, versions: [...] }
5. Version comparison: 0.9 < 0.10 is handled correctly
</verification>

<success_criteria>

- preferences-store.ts has lastSeenVersion field with migration
- use-changelog.ts exports useChangelog hook and ChangelogResult type
- Hook correctly detects version changes using compare-versions library
- All three empty-result reasons are distinguishable
- `bun run build` and `bun run lint` pass
  </success_criteria>

<output>
After completion, create `.planning/phases/01-data-detection/01-02-SUMMARY.md`
</output>
