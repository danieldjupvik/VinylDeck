---
phase: 03-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/use-changelog-trigger.ts
  - src/components/changelog/changelog-auto-trigger.tsx
  - src/routes/_authenticated.tsx
autonomous: true

must_haves:
  truths:
    - 'Modal does not trigger before hydration completes'
    - 'Modal does not trigger while auth is loading'
    - 'Modal does not trigger on OAuth callback route'
    - 'Modal does not trigger if useChangelog returns hasEntries: false'
    - 'Modal triggers once per session (ref guard prevents re-trigger)'
    - 'Modal appears after 750ms delay once all gates pass'
    - 'lastSeenVersion updates to APP_VERSION when modal opens'
  artifacts:
    - path: 'src/hooks/use-changelog-trigger.ts'
      provides: 'Hook coordinating trigger gates and modal state'
      exports: ['useChangelogTrigger']
      min_lines: 40
    - path: 'src/components/changelog/changelog-auto-trigger.tsx'
      provides: 'Component that renders modal based on trigger state'
      exports: ['ChangelogAutoTrigger']
      min_lines: 15
    - path: 'src/routes/_authenticated.tsx'
      provides: 'Authenticated layout with auto-trigger integration'
      contains: 'ChangelogAutoTrigger'
  key_links:
    - from: 'src/hooks/use-changelog-trigger.ts'
      to: 'src/providers/hydration-context.ts'
      via: 'hydration gate'
      pattern: 'useHydrationState'
    - from: 'src/hooks/use-changelog-trigger.ts'
      to: 'src/hooks/use-auth.ts'
      via: 'auth gate'
      pattern: 'useAuth'
    - from: 'src/hooks/use-changelog-trigger.ts'
      to: 'src/hooks/use-changelog.ts'
      via: 'version detection'
      pattern: 'useChangelog'
    - from: 'src/hooks/use-changelog-trigger.ts'
      to: 'src/stores/preferences-store.ts'
      via: 'version marking'
      pattern: 'setLastSeenVersion'
    - from: 'src/routes/_authenticated.tsx'
      to: 'src/components/changelog/changelog-auto-trigger.tsx'
      via: 'component import'
      pattern: 'ChangelogAutoTrigger'
---

<objective>
Create the auto-trigger system that shows the changelog modal on app load when a new version is detected.

Purpose: Users who update to a new version see what changed automatically, without needing to check Settings. The modal only appears once per session and respects hydration/auth/route gates.

Output: A trigger hook with multi-gate logic, an auto-trigger component, and integration into the authenticated layout.
</objective>

<execution_context>
@/Users/danieldjupvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danieldjupvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-integration/03-CONTEXT.md
@.planning/phases/03-integration/03-RESEARCH.md

@src/providers/hydration-context.ts
@src/hooks/use-auth.ts
@src/routes/\_authenticated.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useChangelogTrigger hook with multi-gate logic</name>
  <files>src/hooks/use-changelog-trigger.ts</files>
  <action>
Create the trigger hook that coordinates all conditions before showing the modal.

Gates (all must pass before trigger):

1. `hasTriggeredRef.current === false` (session guard - prevents re-trigger)
2. `hasHydrated === true` (from useHydrationState)
3. `isLoading === false` AND `isAuthenticated === true` (from useAuth)
4. `location.pathname !== '/oauth-callback'` (from useLocation)
5. `changelog.hasEntries === true` (from useChangelog - Phase 1)

Implementation:

```typescript
import { useEffect, useRef, useState } from 'react'
import { useLocation } from '@tanstack/react-router'

import { useAuth } from '@/hooks/use-auth'
import { useChangelog } from '@/hooks/use-changelog'
import { APP_VERSION } from '@/lib/constants'
import { useHydrationState } from '@/providers/hydration-context'
import { usePreferencesStore } from '@/stores/preferences-store'

const TRIGGER_DELAY_MS = 750
```

Hook return type:

```typescript
{ isOpen: boolean; setIsOpen: (open: boolean) => void }
```

Behavior:

1. When all gates pass, set `hasTriggeredRef.current = true`
2. Start a 750ms timer
3. On timer completion:
   - Call `setIsOpen(true)`
   - Call `setLastSeenVersion(APP_VERSION)`
   - Attempt haptic feedback: `if ('vibrate' in navigator) { navigator.vibrate(10) }`
4. Effect cleanup clears the timer if component unmounts

Critical: Mark `hasTriggeredRef.current = true` BEFORE starting the timer, not after. This prevents double-trigger in StrictMode.

TSDoc required:

```typescript
/**
 * Coordinates changelog modal auto-trigger with hydration, auth, route, and version gates.
 * Fires once per session after a 750ms delay when all conditions pass.
 *
 * @returns Modal open state and setter for controlled modal
 */
```

  </action>
  <verify>
```bash
# Verify file exists and exports
grep "export function useChangelogTrigger" src/hooks/use-changelog-trigger.ts

# Verify all gates are checked

grep -E "hasHydrated|isAuthenticated|isLoading|oauth-callback|hasEntries" src/hooks/use-changelog-trigger.ts

# Verify ref guard

grep "hasTriggeredRef" src/hooks/use-changelog-trigger.ts

# Verify delay constant

grep "TRIGGER_DELAY_MS" src/hooks/use-changelog-trigger.ts

# Verify version marking

grep "setLastSeenVersion" src/hooks/use-changelog-trigger.ts

# Type check

bun run build 2>&1 | head -20

````
  </verify>
  <done>
useChangelogTrigger hook created with five gates (session ref, hydration, auth, route, version detection), 750ms trigger delay, lastSeenVersion update on modal open, and optional haptic feedback.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChangelogAutoTrigger component</name>
  <files>src/components/changelog/changelog-auto-trigger.tsx</files>
  <action>
Create a component that uses the trigger hook and renders the modal.

Implementation:

```typescript
import { useChangelog } from '@/hooks/use-changelog'
import { useChangelogTrigger } from '@/hooks/use-changelog-trigger'

import { ChangelogModal } from './changelog-modal'
import { ChangelogContent } from './changelog-content'
````

Component logic:

1. Call `useChangelogTrigger()` to get `{ isOpen, setIsOpen }`
2. Call `useChangelog()` to get version data
3. Early return `null` if `!changelog.hasEntries`
4. Render `<ChangelogModal>` with `open={isOpen}` and `onOpenChange={setIsOpen}`
5. Inside modal, render `<ChangelogContent>` for the latest version (first in `changelog.versions` array)

Props interface: None (this is an auto-contained component)

Note: This component renders content for the latest version only (auto-trigger shows latest, not accordion). The accordion for missed versions is handled separately when modal is opened manually from Settings.

TSDoc required:

```typescript
/**
 * Auto-triggers changelog modal on new version detection.
 * Renders nothing if no new entries. Placed in authenticated layout.
 */
```

  </action>
  <verify>
```bash
# Verify file exists and exports
grep "export function ChangelogAutoTrigger" src/components/changelog/changelog-auto-trigger.tsx

# Verify hook usage

grep "useChangelogTrigger" src/components/changelog/changelog-auto-trigger.tsx

# Verify modal and content usage

grep -E "ChangelogModal|ChangelogContent" src/components/changelog/changelog-auto-trigger.tsx

# Verify early return for no entries

grep "hasEntries" src/components/changelog/changelog-auto-trigger.tsx

# Type check

bun run build 2>&1 | head -20

````
  </verify>
  <done>
ChangelogAutoTrigger component renders modal controlled by trigger hook, displays latest version content, returns null when no entries.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate auto-trigger into authenticated layout</name>
  <files>src/routes/_authenticated.tsx</files>
  <action>
Add ChangelogAutoTrigger to the authenticated layout.

Changes to `src/routes/_authenticated.tsx`:

1. Add import at top:
   ```typescript
   import { ChangelogAutoTrigger } from '@/components/changelog/changelog-auto-trigger'
````

2. Add component inside SidebarInset, after CollectionSyncBanner:
   ```tsx
   <SidebarInset className="relative">
     <div className="pointer-events-none absolute inset-0 ...">
     <div className="relative z-10 flex min-h-svh flex-col">
       <header>...</header>
       <CollectionSyncBanner />
       <ChangelogAutoTrigger />
       <div className="flex-1">
         <Outlet />
       </div>
     </div>
   </SidebarInset>
   ```

Placement rationale:

- After CollectionSyncBanner because it's another "global notification" component
- Inside the authenticated layout ensures all auth gates have passed before component mounts
- The trigger hook still has its own gates, but layout placement provides additional safety

Do NOT modify any other logic in the file. Import and render only.
</action>
<verify>

```bash
# Verify import added
grep "ChangelogAutoTrigger" src/routes/_authenticated.tsx

# Verify component rendered
grep -A 2 "CollectionSyncBanner" src/routes/_authenticated.tsx | grep "ChangelogAutoTrigger"

# Type check
bun run build 2>&1 | head -20

# Lint
bun run lint 2>&1 | head -20
```

  </verify>
  <done>
ChangelogAutoTrigger imported and rendered in authenticated layout after CollectionSyncBanner.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `bun run build` passes
2. `bun run lint` passes
3. Manual testing in dev mode:
   - Set lastSeenVersion to old version in localStorage
   - Clear and reload app
   - Modal should NOT appear during loading spinner
   - Modal should NOT appear on /oauth-callback route
   - Modal should appear ~750ms after authenticated layout renders
   - Modal should NOT re-appear on subsequent page navigations
   - Check localStorage: lastSeenVersion should be updated to current version
     </verification>

<success_criteria>

- useChangelogTrigger hook gates modal behind hydration, auth, route, and version detection
- ChangelogAutoTrigger renders modal controlled by trigger hook
- Modal auto-triggers once per session with 750ms delay
- lastSeenVersion updates to APP_VERSION when modal opens
- Integration in \_authenticated.tsx places component after CollectionSyncBanner
- No new TypeScript or lint errors
  </success_criteria>

<output>
After completion, create `.planning/phases/03-integration/03-01-SUMMARY.md`
</output>
