---
phase: 07-trpc-integration
plan: 02
type: execute
wave: 2
depends_on: ['07-01']
files_modified:
  - src/server/trpc/routers/discogs.ts
  - src/hooks/use-user-profile.ts
  - src/hooks/use-collection.ts
  - src/hooks/use-collection-sync.ts
  - src/server/trpc/error-utils.ts
  - src/server/discogs-client.ts
autonomous: true

must_haves:
  truths:
    - 'Discogs router uses facade client for all data operations'
    - 'No as unknown as casts remain in tRPC router code'
    - 'Client-side hooks consume flat responses without rateLimit destructuring'
    - 'Old error-utils.ts and discogs-client.ts are deleted'
    - 'getCollectionMetadata uses facade method instead of raw perPage=1 call'
  artifacts:
    - path: 'src/server/trpc/routers/discogs.ts'
      provides: 'Discogs router using facade client'
      contains: 'createDiscogsClient'
    - path: 'src/hooks/use-user-profile.ts'
      provides: 'Profile hook with flat response handling'
    - path: 'src/hooks/use-collection.ts'
      provides: 'Collection hook without rateLimit handling'
    - path: 'src/hooks/use-collection-sync.ts'
      provides: 'Sync hook with flat metadata response'
  key_links:
    - from: 'src/server/trpc/routers/discogs.ts'
      to: 'src/server/discogs/index.ts'
      via: 'import createDiscogsClient'
      pattern: 'import.*createDiscogsClient.*from.*discogs/index'
    - from: 'src/server/trpc/routers/discogs.ts'
      to: 'src/server/trpc/error-mapper.ts'
      via: 'import error mapper'
      pattern: 'import.*mapFacadeErrorToTRPC.*from.*error-mapper'
    - from: 'src/hooks/use-user-profile.ts'
      to: 'tRPC discogs.getUserProfile'
      via: 'trpcUtils.client.discogs.getUserProfile.query'
      pattern: "trpcUtils\\.client\\.discogs\\.getUserProfile\\.query"
    - from: 'src/hooks/use-collection.ts'
      to: 'tRPC discogs.getCollection'
      via: 'trpcUtils.client.discogs.getCollection.query'
      pattern: "trpcUtils\\.client\\.discogs\\.getCollection\\.query"
---

<objective>
Migrate the Discogs data router to facade, update client-side hooks for flat response shapes, and delete deprecated files.

Purpose: Completes the tRPC-to-facade migration. After this plan, all tRPC routers use the facade exclusively, client hooks consume flat responses, and no deprecated code remains.
Output: Fully migrated Discogs router, updated hooks, deleted old files.
</objective>

<execution_context>
@/Users/danieldjupvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danieldjupvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-trpc-integration/07-CONTEXT.md
@.planning/phases/07-trpc-integration/07-RESEARCH.md
@.planning/phases/07-trpc-integration/07-01-SUMMARY.md
@src/server/trpc/routers/discogs.ts
@src/server/trpc/error-mapper.ts
@src/server/discogs/index.ts
@src/server/discogs/client.ts
@src/hooks/use-user-profile.ts
@src/hooks/use-collection.ts
@src/hooks/use-collection-sync.ts
@src/api/rate-limiter.ts
@src/types/discogs/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Discogs router to facade</name>
  <files>
    src/server/trpc/routers/discogs.ts
  </files>
  <action>
Rewrite the Discogs router to use the facade. Per user decision, all routers import only from the facade, return flat responses, and eliminate `as unknown as` casts.

**Remove:**

- `import { createDiscogsClient } from '../../discogs-client.js'` (old factory)
- `import { handleDiscogsError } from '../error-utils.js'`
- `import type { DiscogsCollectionRelease, DiscogsPagination } from '../../../types/discogs/index.js'` (no longer needed — facade types flow through)

**Add:**

- `import { createDiscogsClient } from '../../discogs/index.js'` (facade)
- `import { mapFacadeErrorToTRPC } from '../error-mapper.js'`

**getIdentity procedure:**

- Replace `createDiscogsClient(input.accessToken, input.accessTokenSecret)` with `createDiscogsClient({ accessToken: input.accessToken, accessTokenSecret: input.accessTokenSecret })`
- Replace `const { data, rateLimit } = await client.getIdentity()` with `return await client.data.getIdentity()`
- Remove the manual object construction `{ identity: { id, username, ... }, rateLimit }` — return flat, let tRPC infer the type
- Replace `handleDiscogsError(error, 'get identity')` with `mapFacadeErrorToTRPC(error, 'get identity')`

**getCollection procedure:**

- Replace client creation same as above
- Replace `client.user().collection().getReleases(...)` with `client.data.getCollectionReleases(input.username, input.folderId, { page: input.page, perPage: input.perPage, sort: input.sort as any, sortOrder: input.sortOrder as any })`
- The facade's `getCollectionReleases` accepts `sort?: UserSortEnum` and `sortOrder?: SortOrdersEnum`. The Zod enum values (`'label'`, `'artist'`, etc.) match the discojs enum values, so the cast should work. If TypeScript complains about enum compatibility, cast input.sort and input.sortOrder to the appropriate discojs enum types. Import `UserSortEnum` and `SortOrdersEnum` from `discojs` ONLY if absolutely needed for the cast — but prefer letting the facade handle it. Actually, check the facade's DataClient interface: it already accepts `sort?: UserSortEnum`. The Zod-validated strings should be compatible. If not, the facade's buildSortOptions handles the mapping internally.
- IMPORTANT: Remove the `as unknown as DiscogsCollectionRelease[]` and `as unknown as DiscogsPagination` casts entirely — the facade returns properly typed `CollectionResponse` with `{ pagination, releases }`
- Return flat: `return await client.data.getCollectionReleases(...)` — the facade already returns `CollectionResponse` which has `{ pagination, releases }`
- Remove `rateLimit` from the return per user decision (drop rateLimit from all tRPC responses)
- Replace error handler

**getUserProfile procedure:**

- Replace client creation
- Replace `client.user().getProfile(input.username)` with `client.data.getUserProfile(input.username)`
- Return flat: `return await client.data.getUserProfile(input.username)` — facade returns `User` type directly
- Remove the manual field cherry-picking `{ profile: { id, username, avatar_url, email, ... } }` — per user decision, full type pass-through
- Remove `rateLimit` from return
- Replace error handler

**getCollectionMetadata procedure:**

- Replace client creation
- Replace the raw `client.user().collection().getReleases(username, 0, { page: 1, per_page: 1 })` with `client.data.getCollectionMetadata(input.username)` (added to facade in Plan 01)
- Return flat: `return await client.data.getCollectionMetadata(input.username)` — returns `{ totalCount: number }`
- Remove `rateLimit` from return
- Replace error handler

Per user decision: no wrapping, no cherry-picking, full pass-through, no rateLimit in responses.
</action>
<verify>
Run `bunx tsc --noEmit` — no type errors. `grep "as unknown as" src/server/trpc/routers/discogs.ts` returns empty. `grep "handleDiscogsError" src/server/trpc/routers/discogs.ts` returns empty. `grep "discogs-client" src/server/trpc/routers/discogs.ts` returns empty (no old factory import). `grep "rateLimit" src/server/trpc/routers/discogs.ts` returns empty.
</verify>
<done>
Discogs router uses facade exclusively. No `as unknown as` casts. No rateLimit in responses. No direct library imports. All four procedures return flat facade types.
</done>
</task>

<task type="auto">
  <name>Task 2: Update client-side hooks and delete old files</name>
  <files>
    src/hooks/use-user-profile.ts
    src/hooks/use-collection.ts
    src/hooks/use-collection-sync.ts
    src/server/trpc/error-utils.ts
    src/server/discogs-client.ts
  </files>
  <action>
Update client-side hooks to match new flat response shapes per user decision. Then delete deprecated files.

**use-user-profile.ts:**

- Line 73: Change `const { profile } = await trpcUtils.client.discogs.getUserProfile.query({...})` to `const profile = await trpcUtils.client.discogs.getUserProfile.query({...})`
- The response is now the full `User` type from discojs (flat, no wrapping)
- The `UserProfile` interface in this hook picks specific fields. Update the mapping at lines 79-85 to work with the flat response. The facade returns a `User` object with `id`, `username`, `avatar_url`, `email` (among others like `num_collection`, `num_wantlist`). The existing field mapping `{ id: profile.id, username: profile.username, ... }` still works since `profile` is now the direct User object instead of being nested in `{ profile: {...} }`
- No other changes needed — the hook's `UserProfile` interface is an app-specific subset, which is fine

**use-collection.ts:**

- In the `fetchPage` function (~line 292-308): The tRPC response is now a flat `CollectionResponse` (has `.pagination` and `.releases`). Change to:
  ```
  const result = await trpcUtils.client.discogs.getCollection.query({...})
  return result
  ```
- Remove the `rateLimiter.updateFromRateLimit(result.rateLimit)` call and its eslint-disable comment (~lines 303-305)
- Remove `import { rateLimiter } from '@/api/rate-limiter'` if no other usages remain in this file (check first — it should be the only usage)
- The rest of the hook accesses `result.releases` and `result.pagination` which still exist on the flat `CollectionResponse` — no other changes needed
- At line 597: `data?.pagination.per_page` — verify the facade's `Pagination` type has `per_page`. Check `CollectionResponse` from `src/types/discogs/index.ts`: it uses the discojs type which has `perPage` (camelCase) not `per_page`. Update to `data?.pagination.perPage`. Similarly at line 669 (`data.pagination.page`, `.pages`, `.items`, `.per_page`). Check all `pagination.*` property accesses and update from snake_case to camelCase if the discojs types use camelCase. Carefully verify by reading the actual discojs Pagination type fields.

CRITICAL: The discojs types may use different property names than the old @lionralfs types. Before making changes, check what properties the `Pagination` type from `src/types/discogs/index.ts` actually has. The type is `CollectionResponseBase['pagination']` where `CollectionResponseBase = Awaited<ReturnType<Discojs['listItemsByReleaseForUser']>>`. If the property names differ (e.g., `perPage` vs `per_page`, `items` vs `count`), update all usages in use-collection.ts and use-collection-sync.ts accordingly.

**use-collection-sync.ts:**

- Line 8: Remove `import type { DiscogsCollectionResponse } from '@/types/discogs'` — this may need to stay if used for the cached data cast at line 72. Check: the `cachedCollection` cast uses `DiscogsCollectionResponse` to type the query cache data. Keep the import if needed.
- The `meta` from `getCollectionMetadata.useQuery` now returns `{ totalCount: number }` (flat, no rateLimit). Line 86: `meta.totalCount` — this should still work since the new shape is `{ totalCount }` directly.
- If the old response was `{ totalCount, rateLimit }` and hooks destructured rateLimit, remove that. Looking at line 86: `typeof meta.totalCount === 'number'` — this works fine with the new shape.
- Check if `meta` had any `rateLimit` usage — looking at the current code, it doesn't destructure rateLimit from meta, so no changes needed for rateLimit on this hook.
- IMPORTANT: The cached collection data at line 72-76 uses `cachedCollection?.pagination.items`. If the Pagination type from discojs uses a different property name for total items count, update here too.

**Delete deprecated files:**

- Delete `src/server/trpc/error-utils.ts` (replaced by error-mapper.ts in Plan 01)
- Delete `src/server/discogs-client.ts` (old @lionralfs-only factory, replaced by facade)

Per user decision: clean break — delete error-utils.ts in this phase, not Phase 8. discogs-client.ts deletion is also per user decision (routers now use facade only).

After deletions, verify no remaining imports reference these files:

- `grep -r "error-utils" src/` should return empty
- `grep -r "discogs-client" src/server/trpc/` should return empty
  </action>
  <verify>
  Run `bunx tsc --noEmit` — no type errors. Run `bun run lint` — no lint errors. Run `vercel build` — no Vercel-specific errors (`.js` extensions, no `@/` aliases in server code). `grep "rateLimit" src/hooks/use-collection.ts` — should find zero matches for the API response rateLimit (may still find other unrelated usages). `grep "error-utils" src/` returns empty. `grep "{ profile }" src/hooks/use-user-profile.ts` returns empty (no destructuring).
  </verify>
  <done>
  All three client hooks consume flat responses. No rateLimit destructuring from API responses. No `{ profile }` destructuring. Old error-utils.ts and discogs-client.ts deleted with zero dangling imports. Full build passes including Vercel build.
  </done>
  </task>

</tasks>

<verification>
- `bunx tsc --noEmit` passes with no errors
- `bun run lint` passes
- `vercel build` passes (test Vercel serverless compilation)
- `grep -r "as unknown as" src/server/trpc/` returns empty
- `grep -r "handleDiscogsError" src/` returns empty
- `grep -r "error-utils" src/server/trpc/` returns empty
- `grep -r "@lionralfs" src/server/trpc/` returns empty
- `ls src/server/trpc/error-utils.ts` returns "not found"
- `ls src/server/discogs-client.ts` returns "not found"
- All tRPC procedures return flat facade types (no wrapping)
</verification>

<success_criteria>

- Discogs router uses facade exclusively with zero library imports
- No `as unknown as` casts in any tRPC router
- All hooks consume flat responses (no `{ profile }` or `{ rateLimit }` destructuring)
- error-utils.ts and discogs-client.ts are deleted
- TypeScript, ESLint, and Vercel build all pass
- getCollectionMetadata uses facade method (no raw perPage=1 in router)
  </success_criteria>

<output>
After completion, create `.planning/phases/07-trpc-integration/07-02-SUMMARY.md`
</output>
